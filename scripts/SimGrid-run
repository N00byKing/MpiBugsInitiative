#! /bin/sh

# Go to the MBI root directory
cd "$(dirname "$0")"/../
rootdir=$(pwd)

# Check that we have the right image
if [ -e /MBI ] 
then 
   echo "This seems to be a MBI docker image. Good."
else
   echo "Please run this script in a MBI docker image. Run these commands:"
   echo "  docker build -f Dockerfile -t mpi-bugs-initiative:latest . # Only the first time"
   echo "  docker run -it --rm --name MIB --volume $(pwd):/MBI mpi-bugs-initiative /MBI/scripts/SimGrid-run"
   exit 1
fi

set -e # Fail on error

export PATH=$PATH:${rootdir}/builds/SimGrid/bin
export VERBOSE=1

# If this was not run with gilab-ci, we provide a meaningless value
if [ -z "$CI_JOB_ID" ]
then
    CI_JOB_ID=0
fi

test -e ${rootdir}/logs/simgrid || mkdir -p ${rootdir}/logs/simgrid
cd ${rootdir}/logs/simgrid

cp ${rootdir}/builds/SimGrid/cluster.xml .

# Run the script on each code
python3.8 ${rootdir}/scripts/runner.py -x simgrid -o bench_simgrid.csv -t 300 --job $CI_JOB_ID $(ls ${rootdir}/codes/*.c)
